#!/bin/sh -eux

WORKING_DIR=$(pwd)

find . -type f -name '*.opam' | while read P; do
  cd "$(dirname "${P}")"
  eval `opam config env`
  opam install dune -y
  opam pin add -n bitbucket . -y
  opam install --deps-only bitbucket -y

  dune build
  dune runtest

  cd "${WORKING_DIR}"
done
